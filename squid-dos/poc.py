import requests
from requests.auth import HTTPDigestAuth
import random
import string
import hashlib
proxies = {
    'http': 'http://192.168.59.197:3128',
    'https': 'http://192.168.59.197:3128'
}


rr = '''Digest username="test",realm="localhost",nonce="47e5f5dc8b7237cf1153065afe358c89",uri="/",cnonce="a0824a23a0394203c3023085915fd744",nc=00000001,response="b45560b922d64786ef7d6c96c9071dfa",qop="auth"'''

data = '''Digest username="{username}",realm="{realm}",nonce="{nonce}",uri="{uri}",cnonce="{cnonce}",nc={nc},response="{response}",qop="auth"'''


username = "test"
password = "123456"
realm = "localhost"
nc = "000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011000000011"
url = "http://target"
uri = "/"
cnonce = ''.join(random.choice(string.ascii_lowercase + string.digits)
                 for _ in range(32))

ha1 = hashlib.md5((username + ':' + realm + ':' +
                  password).encode('utf-8')).hexdigest()
ha2 = hashlib.md5(("GET:"+uri).encode("utf-8")).hexdigest()


resp = requests.get(url=url, proxies=proxies, verify=False)
if resp.status_code == 407:
    resp_header = resp.headers
    nonce = resp_header["Proxy-Authenticate"].split(
        ',')[1].split('=')[1].rstrip('"').lstrip('"')
response = hashlib.md5(
    (ha1+":"+nonce+":"+nc+":"+cnonce+":auth:"+ha2).encode('utf-8')).hexdigest()
print("nonce: {}\tcnonce: {}\tresponse: {}".format(nonce, cnonce, response))

rdata = data.format(username=username, realm=realm, nonce=nonce,
                    uri="/", cnonce=cnonce, nc=nc, response=response)
header = {
    "Proxy-Authorization": rdata
}

print(rdata)
resp = requests.get(url=url, proxies=proxies, verify=False, headers=header)
print(resp.status_code, resp.text)
